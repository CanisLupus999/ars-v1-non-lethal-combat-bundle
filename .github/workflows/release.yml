name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create module directory
        run: |
          mkdir -p release/ars-v1-non-lethal-combat-bundle
          cp module.json README.md release/ars-v1-non-lethal-combat-bundle/ 2>/dev/null || true
          if [ -d "packs" ]; then cp -r packs release/ars-v1-non-lethal-combat-bundle/; fi
          if [ -d "assets" ]; then cp -r assets release/ars-v1-non-lethal-combat-bundle/; fi
      
      - name: Create ZIP file
        run: |
          cd release
          zip -r ars-v1-non-lethal-combat-bundle.zip ars-v1-non-lethal-combat-bundle/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/ars-v1-non-lethal-combat-bundle.zip
            module.json
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Version ${{ steps.get_version.outputs.VERSION }}
            
            See the [README](https://github.com/${{ github.repository }}/blob/main/README.md) for installation instructions.
            
            **Manifest URL (for auto-updates):**
            ```
            https://raw.githubusercontent.com/${{ github.repository }}/main/module.json
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update main branch with latest release URLs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main:main || true
          git checkout main
          # Update manifest and download URLs in module.json to point to the new release
          sed -i "s|releases/download/v[0-9.]*/module.json|releases/download/${{ github.ref_name }}/module.json|g" module.json
          sed -i "s|releases/download/v[0-9.]*/ars-v1-non-lethal-combat-bundle.zip|releases/download/${{ github.ref_name }}/ars-v1-non-lethal-combat-bundle.zip|g" module.json
          # Also update the version number in module.json to match the release
          sed -i "s|\"version\": \"[0-9.]*\"|\"version\": \"${{ steps.get_version.outputs.VERSION }}\"|g" module.json
          git add module.json
          if ! git diff --staged --quiet; then
            git commit -m "Update manifest URLs to point to release ${{ github.ref_name }}"
            git push origin main
          fi

